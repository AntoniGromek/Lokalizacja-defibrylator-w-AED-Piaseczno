<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>VeloDunajec - Analiza Turystyczna</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #map { width: 100%; height: 100%; }
        
        /* Pywajcy nag贸wek */
        #header {
            position: absolute;
            top: 20px;
            left: 60px; /* Przesunicie, 偶eby nie zasania przycisk贸w */
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }
        #header h1 { margin: 0; font-size: 20px; color: #2c3e50; }
        #header small { color: #7f8c8d; font-size: 12px; }

        /* Panel wynik贸w */
        #sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 1001;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%); /* Ukryty poza ekranem */
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        #sidebar.active { transform: translateX(0); }
        
        .poi-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ccc;
        }
        .poi-rental { border-color: #e74c3c; } /* Czerwony dla rower贸w */
        .poi-food { border-color: #27ae60; }   /* Zielony dla jedzenia */
        .poi-hotel { border-color: #3498db; }  /* Niebieski dla spania */
        
        .close-btn {
            background: none; border: none; font-size: 24px; cursor: pointer; float: right;
        }
        
        /* Legenda kolor贸w w panelu */
        .badge { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="header">
        <h1> VeloDunajec Info</h1>
        <small>Kliknij szlak, aby znale藕 usugi w promieniu <b>500m</b></small>
    </div>

    <div id="sidebar">
        <button class="close-btn" onclick="zamknijPanel()">&times;</button>
        <h2>Wyniki analizy</h2>
        <p id="stats-text">Wybierz tras...</p>
        <div id="results-container"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script src="data/szlaki.js"></script>
    <script src="data/poi.js"></script>

    <script>
        // 1. Mapa ustawiona na Pieniny (Szczawnica)
        var map = L.map('map').setView([49.423, 20.460], 13);

        // 2. Warstwy podkadowe
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
        
        var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'OpenTopoMap',
            maxZoom: 17
        });

        var orto = L.tileLayer.wms('https://mapy.geoportal.gov.pl/wss/service/PZGIK/ORTO/WMS/StandardResolution', {
            layers: 'Raster',
            format: 'image/png',
            transparent: true,
            attribution: 'Geoportal'
        });

        // Domylnie wczamy Topo, bo w g贸rach wyglda najlepiej
        topo.addTo(map);

        // 3. Warstwy analityczne
        var bufferLayer;
        var poiLayer;

        // 4. Obsuga Szlak贸w (VeloDunajec)
        var szlaki = L.geoJSON(daneSzlaki, {
            style: { color: '#8e44ad', weight: 5, opacity: 0.8 }, // Fioletowy wyr贸偶nia si na zieleni g贸r
            onEachFeature: function(feature, layer) {
                // Efekt hover
                layer.on('mouseover', function() { this.setStyle({ color: '#e74c3c', weight: 7 }); });
                layer.on('mouseout', function() { this.setStyle({ color: '#8e44ad', weight: 5 }); });
                
                // Kliknicie - analiza
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    wykonajAnalize(feature);
                });
                
                // Popup z nazw
                var nazwa = feature.properties.name || "Szlak rowerowy";
                if(feature.properties.ref) nazwa += " (" + feature.properties.ref + ")";
                layer.bindPopup("<b>" + nazwa + "</b><br>Kliknij, aby szuka usug.");
            }
        }).addTo(map);

        // --- FUNKCJA ANALITYCZNA ---
        function wykonajAnalize(featureSzlaku) {
            // A. Reset widoku
            if(bufferLayer) map.removeLayer(bufferLayer);
            if(poiLayer) map.removeLayer(poiLayer);
            document.getElementById('results-container').innerHTML = '';

            // B. Buforowanie (Turf.js) - 500m
            var bufor = turf.buffer(featureSzlaku, 0.5, { units: 'kilometers' });
            
            // C. Rysowanie bufora
            bufferLayer = L.geoJSON(bufor, {
                style: { color: '#34495e', fillColor: '#34495e', fillOpacity: 0.1, dashArray: '5,5', weight: 2 }
            }).addTo(map);

            // D. Szukanie punkt贸w w buforze
            var znalezione = turf.pointsWithinPolygon(danePoi, bufor);

            // E. Rysowanie znalezionych punkt贸w
            poiLayer = L.geoJSON(znalezione, {
                pointToLayer: function(feature, latlng) {
                    var type = feature.properties.amenity || feature.properties.tourism;
                    var color = 'gray';
                    var klasa = '';

                    // Logika kolor贸w
                    if (type && (type.includes('bicycle') || type === 'parking')) { color = '#e74c3c'; klasa='poi-rental'; }
                    else if (type && (type.includes('restaurant') || type.includes('cafe') || type.includes('bar'))) { color = '#27ae60'; klasa='poi-food'; }
                    else if (type && (type.includes('hotel') || type.includes('guest'))) { color = '#3498db'; klasa='poi-hotel'; }

                    return L.circleMarker(latlng, {
                        radius: 7, fillColor: color, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.9, className: klasa // przechowujemy klase w opcjach hack
                    });
                },
                onEachFeature: function(f, l) {
                    l.bindPopup("<b>" + (f.properties.name || "Obiekt bez nazwy") + "</b>");
                }
            }).addTo(map);

            // F. Wypenienie panelu bocznego
            generujListe(znalezione);
            
            // Zoom do bufora
            map.fitBounds(bufferLayer.getBounds());
        }

        function generujListe(data) {
            var container = document.getElementById('results-container');
            var sidebar = document.getElementById('sidebar');
            var stats = document.getElementById('stats-text');
            
            sidebar.classList.add('active');
            
            var count = data.features.length;
            stats.innerHTML = `Znaleziono obiekt贸w: <b>${count}</b>`;

            if(count === 0) {
                container.innerHTML = "<p>Brak usug w pobli偶u tego odcinka.</p>";
                return;
            }

            data.features.forEach(function(f) {
                var props = f.properties;
                var type = props.amenity || props.tourism || "Inne";
                var name = props.name || "Bez nazwy";
                
                // Ustalanie klasy CSS dla ramki
                var cssClass = 'poi-card';
                if(type.includes('bicycle')) cssClass += ' poi-rental';
                else if(type.includes('restaurant') || type.includes('cafe')) cssClass += ' poi-food';
                else if(type.includes('hotel')) cssClass += ' poi-hotel';

                var html = `
                    <div class="${cssClass}">
                        <strong>${name}</strong><br>
                        <small style="text-transform:uppercase; color:#666">${type.replace('_', ' ')}</small>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function zamknijPanel() {
            document.getElementById('sidebar').classList.remove('active');
            if(bufferLayer) map.removeLayer(bufferLayer);
            if(poiLayer) map.removeLayer(poiLayer);
            map.fitBounds(szlaki.getBounds()); // Powr贸t do widoku og贸lnego
        }

        // 5. Kontrolki
        var baseMaps = {
            "G贸ry (Topo)": topo,
            "Mapa Ulic (OSM)": osm,
            "Satelita (Geoportal)": orto
        };
        
        var overlays = {
            "Trasy Rowerowe": szlaki
        };

        L.control.layers(baseMaps, overlays).addTo(map);
        L.control.scale().addTo(map);

        // Wtyczka Geoman (rysowanie)
        map.pm.addControls({ position: 'topleft' });

    </script>
</body>
</html>